name: Deploy Dash App to VPS (Prod + Staging)

on:
  push:
    branches:
      - '**'  # Trigger on push to any branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_PORT: ${{ secrets.VPS_PORT }}
      SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      PROJECT_NAME: Geopolitics

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Add SSH private key
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Deploy to VPS based on branch
        run: |
          BRANCH="${GITHUB_REF##*/}"
          echo "üöÄ Starting deployment for branch: $BRANCH"

          if [ "$BRANCH" = "main" ]; then
            ENV="production"
            PORT=8050
            SCREEN_NAME="dash_prod"
            REPO_PATH="/home/$VPS_USER/$PROJECT_NAME"
          else
            ENV="staging"
            SAFE_BRANCH_NAME=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9]/_/g')
            PORT=$((8100 + RANDOM % 1000))
            SCREEN_NAME="dash_$SAFE_BRANCH_NAME"
            REPO_PATH="/home/$VPS_USER/${PROJECT_NAME}_$SAFE_BRANCH_NAME"
          fi

          echo "üåç Environment: $ENV"
          echo "üìÅ Repo Path: $REPO_PATH"
          echo "üîå Port: $PORT"

          ssh -v -o StrictHostKeyChecking=no -p $VPS_PORT $VPS_USER@$VPS_HOST bash << EOF
            set -e

            echo "üõ† Preparing environment on server..."
            if [ ! -d "$REPO_PATH" ]; then
              git clone -b $BRANCH git@github.com:AlexRuedaPayen/$PROJECT_NAME.git "$REPO_PATH"
            else
              cd "$REPO_PATH"
              git fetch origin "$BRANCH"
              git checkout "$BRANCH"
              git pull origin "$BRANCH"
            fi

            cd "$REPO_PATH"

            echo "üêç Setting up virtual environment..."
            python3 setup_environment.py

            echo "üõë Killing existing app screen (if running)..."
            screen -S "$SCREEN_NAME" -X quit || true

            echo "üöÄ Starting Dash app in new screen session..."
            screen -dmS "$SCREEN_NAME" bash -c '
              cd "$REPO_PATH"
              source venv/bin/activate
              export APP_ENV=$ENV
              export DASH_PORT=$PORT
              python3 dash_app.py
            '

            echo "‚úÖ Deployment complete for branch $BRANCH on port $PORT in $ENV mode."
EOF
