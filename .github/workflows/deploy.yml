name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH keys
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
            # Set up SSH keys and configure for GitHub access on VPS
            mkdir -p ~/.ssh
            echo "$VPS_SSH_KEY" > ~/.ssh/github_deploy_key
            chmod 600 ~/.ssh/github_deploy_key

            # Set up SSH config
            echo "Host github.com
                    IdentityFile ~/.ssh/github_deploy_key
                    StrictHostKeyChecking no" >> ~/.ssh/config
            chmod 600 ~/.ssh/config

      - name: Deploy over SSH to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          # SSH into VPS and deploy
          ssh -p $VPS_PORT $VPS_USER@$VPS_HOST << 'EOF'
            # Ensure the directory exists, otherwise clone the repo
            if [ ! -d "/home/$VPS_USER/Geopolitics" ]; then
                git clone git@github.com:AlexRuedaPayensername/Geopolitics.git /home/$VPS_USER/Geopolitics
            else
                cd /home/$VPS_USER/Geopolitics && git pull
            fi

            # Set up virtual environment and dependencies
            cd /home/$VPS_USER/Geopolitics
            python3 setup_environment.py

            # Restart the service
            sudo systemctl restart geopolitics-dashboard.service
          EOF
