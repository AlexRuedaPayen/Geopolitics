name: Deploy Dash App to VPS (Prod + Staging)

on:
  push:
    branches:
      - '**'  # Trigger on push to any branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_PORT: ${{ secrets.VPS_PORT }}
      SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      PROJECT_NAME: Geopolitics

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Add SSH private key
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Deploy to VPS based on branch
        run: |
          ssh -v -o StrictHostKeyChecking=no -p $VPS_PORT $VPS_USER@$VPS_HOST << 'EOF'
            set -e

            BRANCH="${{ github.ref_name }}"
            echo "🚀 Starting deployment for branch: \$BRANCH"

            if [ "\$BRANCH" = "main" ]; then
              ENV="production"
              PORT=8050
              SCREEN_NAME="dash_prod"
              REPO_PATH="/home/${{ secrets.VPS_USER }}/Geopolitics"
            else
              ENV="staging"
              PORT=$((RANDOM % 1000 + 8100))  # optional: random port per branch
              SCREEN_NAME="dash_\${BRANCH//[^a-zA-Z0-9]/_}"
              REPO_PATH="/home/${{ secrets.VPS_USER }}/Geopolitics_\${BRANCH//[^a-zA-Z0-9]/_}"
            fi

            echo "🌍 Environment: \$ENV"
            echo "📁 Repo Path: \$REPO_PATH"
            echo "🔌 Port: \$PORT"

            # Clone or update
            if [ ! -d "\$REPO_PATH" ]; then
              git clone -b "\$BRANCH" git@github.com:AlexRuedaPayen/Geopolitics.git "\$REPO_PATH"
            else
              cd "\$REPO_PATH"
              git fetch origin "\$BRANCH"
              git checkout "\$BRANCH"
              git pull origin "\$BRANCH"
            fi

            # Virtualenv
            cd "\$REPO_PATH"
            python3 setup_environment.py

            # Kill existing process
            screen -S "\$SCREEN_NAME" -X quit || true

            # Start new instance
            screen -dmS "\$SCREEN_NAME" bash -c "
              cd '\$REPO_PATH'
              source venv/bin/activate
              export APP_ENV=\$ENV
              export DASH_PORT=\$PORT
              venv/bin/python3 dash_app.py
            "

            echo "✅ Deployed branch \$BRANCH on port \$PORT in \$ENV mode."
          EOF
